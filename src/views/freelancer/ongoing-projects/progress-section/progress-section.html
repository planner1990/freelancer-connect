<div>
  <v-container>
    <v-row>
      <v-expansion-panels>
        <v-expansion-panel>
          <v-expansion-panel-header>
            <template v-slot:default="{ open }">
              <span style="position: absolute;left: 60px;">
                <v-menu
                  bottom
                  origin="center center"
                  transition="scale-transition"
                  offset-y
                >
                  <template v-slot:activator="{ on, attrs }">
                    <v-btn icon v-bind="attrs" v-on="on">
                      <v-icon>mdi-dots-vertical</v-icon>
                    </v-btn>
                  </template>

                  <v-list>
                    <v-list-item>
                      <v-list-item-title>
                        <v-dialog
                          v-model="dialog2"
                          persistent
                          width="500"
                          max-width="500"
                        >
                          <template v-slot:activator="{ on, attrs }">
                            <v-btn
                              text
                              v-bind="attrs"
                              v-on="on"
                              color="#62737a"
                            >
                              <v-icon>mdi-close-circle-outline</v-icon> درخواست
                              لغو پروژه
                            </v-btn>
                          </template>
                          <v-card>
                            <v-card-title
                              class="text-h5 mb-8 d-flex justify-space-between"
                            >
                              درخواست لغو پروژه
                              <v-btn
                                depressed
                                text
                                fab
                                @click="dialog2 = false"
                              >
                                <v-icon>
                                  mdi-close
                                </v-icon>
                              </v-btn>
                            </v-card-title>
                            <v-card-text>
                              <v-textarea
                                label="دلیل لغو پروژه را بنویسید..."
                                auto-grow
                                outlined
                                rows="4"
                                v-model="rejDesc"
                              ></v-textarea>
                            </v-card-text>
                            <v-card-actions>
                              <v-spacer></v-spacer>
                              <v-btn
                                color="secondary"
                                text
                                @click="dialog2 = false"
                              >
                                بازگشت
                              </v-btn>
                              <v-btn
                                color="secondary"
                                text
                                @click="cancelProject"
                              >
                                بله, لغو پروژه
                              </v-btn>
                            </v-card-actions>
                          </v-card>
                        </v-dialog>
                      </v-list-item-title>
                    </v-list-item>
                  </v-list>
                </v-menu>
              </span>

              <v-row no-gutters>
                <v-col cols="4">
                  نام پروژه: {{projectDetails.title}}
                </v-col>
                <v-col cols="7">
                  {{ projectDetails.description | readMore(30, "...") }}
                </v-col>
                <v-col cols="8" class="text--secondary">
                  <v-fade-transition leave-absolute>
                    <span class="d-block mt-3" v-if="open" key="0">
                      نام کارفرما: {{ projectDetails.username }}
                    </span>
                    <span v-else key="1">
                      <!--                      {{ trip.name }}-->
                    </span>
                  </v-fade-transition>
                </v-col>
              </v-row>
            </template>
          </v-expansion-panel-header>
          <v-expansion-panel-content>
            <div class="container--fluid d-lg-flex d-md-block project-row">
              <div
                class="col-lg-8 col-md-12 d-flex flex-column align-start justify-center"
              >
                <div>
                  <span
                    ><v-icon color="primary">mdi-check-circle</v-icon>
                    {{ projectDetails.username }}
                  </span>
                </div>
                <div class="font-weight-medium mx-2">
                  {{projectDetails.title}}
                </div>
                <span>
                  {{ projectDetails.description }}
                </span>
              </div>
              <div class="col-lg-4 col-md-12 d-flex">
                <div class="row justify-space-around align-center">
                  <div>
                    <v-icon class="mb-1">
                      mdi-cash-multiple
                    </v-icon>
                    {{projectDetails.price | roundNumber | thousandMask}} ریال
                  </div>
                  <div>
                    <v-icon>
                      mdi-timetable
                    </v-icon>
                    بیشتر از یک هفته
                  </div>
                </div>
              </div>
            </div>
          </v-expansion-panel-content>
        </v-expansion-panel>
      </v-expansion-panels>
    </v-row>
  </v-container>

  <header-section
    :headerSectionTitle="'مراحل تحویل پروژه (تایم لاین انجام پروژه)'"
  ></header-section>
  <v-container>
    <v-row class="progress-level">
      <v-col
        class="level"
        v-for="(mileStone, mileStoneIndex) in mileStones"
        :key="mileStoneIndex"
        :class="{'lock': !mileStone['payment_status'], 'pending': mileStone['payment_status'] === 0 || mileStone['payment_status'] === 1, 'finished': mileStone['confirmation'] === 1}"
      >
        <div class="d-flex justify-space-between align-center">
          <div>
            <!--          <div>بخش {{installments | installments}}</div>-->
            <div
              class="lock-text"
              v-if="mileStone['payment_status'] === undefined"
            >
              <v-tooltip top>
                <template v-slot:activator="{ on, attrs }">
                  <span v-bind="attrs" v-on="on">در انتظار ارسال</span>
                </template>
                <span style="font-size: 11px;"
                  >تا زمان تایید مرحله‌ قبل, امکان ارسال این بخش وجود ندارد.
                </span>
              </v-tooltip>
            </div>
            <div class="lock-text" v-if="mileStone['confirmation'] === 0">
              ارسال شد (در انتظار تایید کارفرما)
            </div>
            <!--            <div-->
            <!--              v-if="mileStone['payment_status'] === 1 || mileStone['payment_status'] === 2"-->
            <!--            >-->
            <!--              ارسال شد (در انتظار تایید کارفرما)-->
            <!--            </div>-->
            <div v-if="mileStone['confirmation'] === 1">خاتمه یافته</div>
          </div>
          <div>
            <v-dialog
              v-if="mileStone['confirmation'] === 1"
              v-model="dialogDownloadFile"
              persistent
              max-width="400px"
            >
              <template v-slot:activator="{ on, attrs }">
                <v-btn
                  class="ma-2"
                  color="secondary"
                  depressed
                  v-bind="attrs"
                  v-on="on"
                  small
                >
                  بررسی فایل
                </v-btn>
              </template>
              <v-form ref="form" v-model="valid" lazy-validation>
                <v-card
                  class="d-flex flex-column justify-center align-center pb-10 send-jobOffer-freelancer"
                >
                  <v-card-title>
                    <span class="text-h6">لیست فایل ها</span>
                  </v-card-title>
                  <v-card-text>
                    <v-container>
                      <v-row>
                        <v-col cols="12">
                          <v-text-field
                            :value="mileStone.description"
                            label="لینک ارسال شده"
                            outlined
                            dense
                          ></v-text-field>
                        </v-col>
                        <v-col cols="12">
                          <v-list>
                            <v-list-item
                              v-for="(file, index) in mileStone.attachments"
                              :key="index"
                              style="background-color: #0a3d62"
                            >
                              <v-list-item-content>
                                <v-list-item-title>
                                  فایل پروژه شماره {{index + 1}}
                                </v-list-item-title>
                              </v-list-item-content>
                              <v-list-item-action>
                                <v-btn icon :href="file" target="_blank">
                                  <v-icon small>mdi-arrow-down</v-icon>
                                </v-btn>
                              </v-list-item-action>
                            </v-list-item>
                          </v-list>
                        </v-col>
                      </v-row>
                    </v-container>
                  </v-card-text>
                  <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn outlined color="error" @click="dialogDownloadFile = false">
                      بستن
                    </v-btn>
                  </v-card-actions>
                </v-card>
              </v-form>
            </v-dialog>
          </div>
          <v-dialog
            v-if="mileStone['payment_status'] === undefined"
            v-model="dialog"
            persistent
            max-width="600px"
          >
            <template v-slot:activator="{ on, attrs }">
              <v-btn
                v-if="mileStoneIndex === unlock"
                class="ma-2"
                color="primary"
                outlined
                v-bind="attrs"
                v-on="on"
                small
              >
                ارسال فایل
              </v-btn>
            </template>
            <v-form ref="form" v-model="valid" lazy-validation>
              <v-card
                class="d-flex flex-column justify-center align-center pb-10 send-jobOffer-freelancer"
              >
                <v-card-title>
                  <span class="text-h5">تکمیل بخش دوم</span>
                </v-card-title>
                <v-card-text>
                  <v-container>
                    <v-row>
                      <v-col cols="12">
                        <v-text-field
                          label="لینک"
                          outlined
                          dense
                          v-model="jobOfferForm.linkName"
                        ></v-text-field>
                      </v-col>
                      <v-col cols="12">
                        <v-file-input
                          @change="handleFileInput($event)"
                          counter
                          label="فایل پیوستی"
                          append-icon="mdi-paperclip"
                          prepend-icon=""
                          :loading="loading"
                          outlined
                          dense
                          multiple
                          :show-size="1000"
                        >
                          <template v-slot:selection="{ index, text }">
                            <v-chip v-if="index < 3" dark label small>
                              {{ text }}
                            </v-chip>

                            <span
                              v-else-if="index === 3"
                              class="text-overline grey--text text--darken-3 mx-2"
                            >
                              +{{ files.length - 3 }} File(s)
                            </span>
                          </template>
                        </v-file-input>
                      </v-col>
                    </v-row>
                  </v-container>
                  <small>*موارد ستاره دار خالی نماند.</small>
                </v-card-text>
                <v-card-actions>
                  <v-spacer></v-spacer>
                  <v-btn color="error" @click="dialog = false">
                    بستن
                  </v-btn>
                  <v-btn
                    color="primary"
                    :disabled="!jobOfferForm.linkName && !jobOfferForm.attachmentId"
                    @click="submitMilestone(unlock)"
                  >
                    ارسال
                  </v-btn>
                </v-card-actions>
              </v-card>
            </v-form>
          </v-dialog>
        </div>
      </v-col>
    </v-row>
  </v-container>
  <v-container>
    <v-row class="mx-8">
      <v-col cols="12" class="pa-0 chat-box">
        <div class="d-flex justify-space-between chat-box-header">
          <div>
            <div class="chat-box-header-title">
              <v-icon color="#142226">mdi-message-text-outline</v-icon>
              قسمت گفتگو
            </div>
            <div class="chat-box-header-subject">{{authenticated.name}}</div>
          </div>
          <div>
            <!--            <v-dialog-->
            <!--              v-model="dialog"-->
            <!--              persistent-->
            <!--              max-width="350px"-->
            <!--              v-if="subject['closed_at'] === null"-->
            <!--            >-->
            <!--              <template v-slot:activator="{ on, attrs }">-->
            <!--                <v-btn-->
            <!--                  v-bind="attrs"-->
            <!--                  v-on="on"-->
            <!--                  :ripple="false"-->
            <!--                  depressed-->
            <!--                  color="red lighten-5"-->
            <!--                  dark-->
            <!--                  class="create-btn"-->
            <!--                >-->
            <!--                  <img-->
            <!--                    src="../../../../../assets/image/circles-delete-cross.png"-->
            <!--                    alt=""-->
            <!--                  />بستن تیکت-->
            <!--                </v-btn>-->
            <!--              </template>-->
            <!--              <v-form ref="form" lazy-validation>-->
            <!--                <v-card-->
            <!--                  class="d-flex flex-column justify-center align-center pb-10 send-jobOffer-freelancer"-->
            <!--                >-->
            <!--                  <v-card-text>-->
            <!--                    <v-container>-->
            <!--                      <v-row>-->
            <!--                        <v-col cols="12">-->
            <!--                          آیا قصد بستن تیکت را دارید؟-->
            <!--                        </v-col>-->
            <!--                      </v-row>-->
            <!--                    </v-container>-->
            <!--                  </v-card-text>-->
            <!--                  <v-card-actions>-->
            <!--                    <v-spacer></v-spacer>-->
            <!--                    <v-btn color="#ff0000" dark @click="dialog = false">-->
            <!--                      خیر-->
            <!--                    </v-btn>-->
            <!--                    <v-btn color="#1ad715" dark @click="closeTicket">-->
            <!--                      بله-->
            <!--                    </v-btn>-->
            <!--                  </v-card-actions>-->
            <!--                </v-card>-->
            <!--              </v-form>-->
            <!--            </v-dialog>-->
          </div>
        </div>
        <div class="chat-box-body">
          <section ref="chatArea" class="chat-area ma-0">
            <p
              v-for="message in messages"
              class="message d-flex align-center"
              :class="{ 'message-out': message.role === 'freelancer', 'message-in': message.role === 'employer'}"
            >
              <img
                :src="authenticated.avatar !== null ? authenticated.avatar : require(`../../../../assets/image/connectalogo.png`)"
                v-if="message.role === 'freelancer'"
                alt="connecta"
                class="side-avatar"
              />
              <!--              <span-->
              <!--                class="d-block ml-auto"-->
              <!--                v-if="message.role === 'freelancer' "-->
              <!--              >-->
              <!--                <v-avatar>-->
              <!--                  <img-->
              <!--                    style="height: auto"-->
              <!--                    :src="message.avatar !== null ? message.avatar : require(`../../../../assets/image/connectalogo.png`)"-->
              <!--                    alt="connecta"-->
              <!--                  />-->
              <!--                </v-avatar>-->
              <!--                {{message.name}}</span-->
              <!--              >-->
              <span>
                <span class="d-block">{{ message.text }}</span>
                <span class="d-block">
                  <a
                    v-if="message.attachment"
                    :href="message.attachment"
                    download
                    target="_blank"
                    class="d-flex mt-4 attachment-link"
                  >
                    <img
                      src="../../../../assets/image/attachment-link.1.png"
                      alt=""
                    />
                    <span style="">دانلود پیوست</span>
                  </a>
                </span>
              </span>
              <span
                class="d-block mr-auto"
                v-if="message.role === 'employer' || message.role === 'admin'"
              >
                <img
                  :src="message.avatar !== null ? message.avatar : require(`../../../../assets/image/connectalogo.png`)"
                  alt="connecta"
                  class="side-avatar-answer"
                />
              </span>
            </p>
          </section>
        </div>
        <div class="chat-box-footer">
          <section class="chat-inputs">
            <form
              class="d-flex justify-space-between align-center"
              @submit.prevent="sendMessage('out')"
              id="person2-form"
              style="position: relative"
            >
              <v-textarea
                v-model="youMessage"
                class="mt-6 col-10 mx-auto ticket-input message-box"
                type="text"
                label="پیام شما"
                rows="2"
                height="70"
                outlined
                dense
                no-resize
                @click:append="toggleFile"
                @keyup.enter.prevent="sendMessage('out')"
              >
                <!--                  :append-icon="'mdi-paperclip'"-->
              </v-textarea>
              <v-btn
                depressed
                class="send-ticket"
                color="secondary"
                large
                type="submit"
              >
                <v-icon color="white" size="20">
                  mdi-arrow-up
                </v-icon>
              </v-btn>
              <v-file-input
                @change="getFileInput($event)"
                v-model="fileInput"
                id="avatar"
                prepend-icon="mdi-paperclip"
                outlined
                style="position: absolute;top: -26px;right: 88px;width: 73%;"
                :class="{ 'isShow': isShow === true, 'isNone': isShow === false }"
                dense
                multiple
                small-chips
                :show-size="1000"
              >
                <template v-slot:selection="{ index, text }">
                  <v-chip v-if="index < 2" dark label small>
                    {{ text }}
                  </v-chip>
                  <span
                    v-else-if="index === 2"
                    class="text-overline grey--text text--darken-3 mx-2"
                  >
                    +{{ fileInput.length - 2 }} File(s)
                  </span>
                </template>
              </v-file-input>
              <!--              <v-file-input-->
              <!--                @change="getFileInput($event)"-->
              <!--                counter-->
              <!--                id="avatar"-->
              <!--                style="display:none"-->
              <!--                label="فایل پیوستی"-->
              <!--                placeholder="Select your files"-->
              <!--                prepend-icon="mdi-paperclip"-->
              <!--                outlined-->
              <!--                dense-->
              <!--                multiple-->
              <!--                :show-size="1000"-->
              <!--              >-->
              <!--                <template v-slot:selection="{ index, text }">-->
              <!--                  <v-chip v-if="index < 3" dark label small>-->
              <!--                    {{ text }}-->
              <!--                  </v-chip>-->

              <!--                  <span-->
              <!--                    v-else-if="index === 3"-->
              <!--                    class="text-overline grey&#45;&#45;text text&#45;&#45;darken-3 mx-2"-->
              <!--                  >-->
              <!--                    +{{ files.length - 3 }} File(s)-->
              <!--                  </span>-->
              <!--                </template>-->
              <!--              </v-file-input>-->
              <!--              <v-btn-->
              <!--                v-if="!completedAt"-->
              <!--                depressed-->
              <!--                class="mb-4"-->
              <!--                large-->
              <!--                color="primary"-->
              <!--                type="submit"-->
              <!--              >-->
              <!--                ارسال پیام-->
              <!--                <v-icon class="mx-2">-->
              <!--                  mdi-message-text-->
              <!--                </v-icon>-->
              <!--              </v-btn>-->
              <!--              <v-btn-->
              <!--                v-if="subject['closed_at'] !== null"-->
              <!--                depressed-->
              <!--                class="mb-4 mt-5"-->
              <!--                style="max-width: 300px"-->
              <!--                large-->
              <!--                block-->
              <!--                disabled-->
              <!--              >-->
              <!--                پیام بسته شد-->
              <!--              </v-btn>-->
            </form>
          </section>
        </div>
      </v-col>
    </v-row>
    <v-row>
      <snackbar
        :snackbarMessage="snackbarMessage"
        :showSnackbar="showSnackbar"
        @hideSnackbar="hideSnackbar"
      ></snackbar>
    </v-row>
  </v-container>
</div>
